<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:SteamAchievementCardManager.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:behaviors="using:SteamAchievementCardManager.Behaviors"
        xmlns:converters="clr-namespace:SteamAchievementCardManager.Converters"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
        x:Class="SteamAchievementCardManager.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="Steam Achievements and Cards Manager"
        TransparencyLevelHint="AcrylicBlur"
        Background="Transparent"
        x:Name="RootWindow"
        ExtendClientAreaToDecorationsHint="True">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Window.Resources>
        <vm:NullToBoolConverter x:Key="NullToBoolConverter"/>
        <SolidColorBrush x:Key="SearchHoverBrush" Color="#33FFFFFF"/>
        <SolidColorBrush x:Key="TextControlBackgroundPointerOver" Color="Transparent"/>
        <SolidColorBrush x:Key="TextControlBorderBrushPointerOver" Color="Transparent"/>
        <SolidColorBrush x:Key="TextControlBackgroundFocused" Color="Transparent"/>
        <SolidColorBrush x:Key="TextControlBorderBrushFocused" Color="Transparent"/>
        <converters:RecentGamesToVisibilityConverter x:Key="RecentGamesToVisibilityConverter"/>

    </Window.Resources>
    <Window.Styles>
        <Style Selector="TextBox.search">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="FocusAdorner" Value="{x:Null}"/>
            <Setter Property="MinHeight" Value="44"/>
            <Setter Property="Padding" Value="16,12"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
        <Style Selector="TextBox.search:pointerover">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
        </Style>
        <Style Selector="TextBox.search:focus">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
        </Style>
        <Style Selector="TextBox.search:focus-within">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="TextBox.search /template/ Border#border:pointerover">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="TextBox.search /template/ Border#border:focus-within">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="ExperimentalAcrylicBorder.search-container:pointerover Border.hover-overlay">
            <Setter Property="Background" Value="{StaticResource SearchHoverBrush}"/>
        </Style>
        <Style Selector="ExperimentalAcrylicBorder.sort-container:pointerover Border.hover-overlay">
            <Setter Property="Background" Value="{StaticResource SearchHoverBrush}"/>
        </Style>
    </Window.Styles>

    <Grid>
        <Image Source="/Assets/background_blur.jpg" Stretch="UniformToFill"/>
        <ExperimentalAcrylicBorder IsHitTestVisible="False">
            <ExperimentalAcrylicBorder.Material>
                <ExperimentalAcrylicMaterial
                    TintColor="Black"
                    TintOpacity="0.8"
                    MaterialOpacity="0.8"/>
            </ExperimentalAcrylicBorder.Material>
        </ExperimentalAcrylicBorder>
        <!-- Barra superior arrastável em toda a largura -->
        <Grid Height="48" Background="Transparent" PointerPressed="TitleBar_PointerPressed"
              HorizontalAlignment="Stretch" VerticalAlignment="Top" ZIndex="10"/>
            <TextBlock Text="Steam Achievement Manager"
                   Margin="220,20,0,0"
                   Foreground="Gray"
                   FontSize="18"
                   FontWeight="SemiBold"
                   HorizontalAlignment="Left"
                   VerticalAlignment="Top"
                   IsHitTestVisible="False"
                   ZIndex="5"/>

        <!-- Layout principal -->
        <Grid ColumnDefinitions="200,*" Background="#33000000" >
            <!-- Sidebar preta translúcida -->
            <Border Grid.Column="0" Background="#99000000">
                <StackPanel>
                    <!-- Barra superior arrastável -->
                    <Grid Height="20" Background="Transparent" PointerPressed="TitleBar_PointerPressed" Margin="0,0,0,10">
                    </Grid>
                    <!-- Avatar + Nome -->
                    <StackPanel Orientation="Vertical" Margin="16,0,16,16" Spacing="6" HorizontalAlignment="Center">
                        <Image Width="64" Height="64"
                               Source="{Binding SteamAvatar}"
                               Stretch="UniformToFill">
                            <Image.Clip>
                                <EllipseGeometry Center="32,32" RadiusX="32" RadiusY="32"/>
                            </Image.Clip>
                        </Image>
                        <TextBlock HorizontalAlignment="Center"
                                   Foreground="White"
                                   FontWeight="Bold"
                                   Text="{Binding SteamUserName}"/>
                    </StackPanel>
           
                    <TextBlock Text="{Binding SteamLevel, StringFormat='Nível {0}'}" 
                               Foreground="LightGray"
                               FontSize="14"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"/>



                
                </StackPanel>
            </Border>

            <!-- Conteúdo principal -->
            <Grid Grid.Column="1" Margin="0,48,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>   <!-- Barra de pesquisa -->
                    <RowDefinition Height="Auto"/>   <!-- Recentes -->
                    <RowDefinition Height="*"/>      <!-- Lista de jogos -->
                </Grid.RowDefinitions>
                
                <!-- Se houver erro -->
                <TextBlock Grid.Row="0"
                           Text="{Binding ErrorMessage}" 
                           Foreground="Red"
                           FontSize="18"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           TextWrapping="Wrap"
                           TextAlignment="Center"
                           IsVisible="{Binding ErrorMessage, Converter={StaticResource NullToBoolConverter}}"/>

                <!-- Barra de pesquisa -->
                <Grid Grid.Row="0" Margin="20,10,10,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <ExperimentalAcrylicBorder Grid.Column="0"
                                               Classes="search-container"
                                               CornerRadius="12"
                                               Margin="0,0,10,0"
                                               ClipToBounds="True">
                        <ExperimentalAcrylicBorder.Material>
                            <ExperimentalAcrylicMaterial
                                TintColor="Black"
                                TintOpacity="0.35"/>
                        </ExperimentalAcrylicBorder.Material>

                        <Grid>
                            <TextBox
                                Classes="search"
                                Watermark="Search game..."
                                Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                BorderThickness="0"
                                Padding="12,6"
                                FontSize="14"
                                Background="Transparent"
                                Foreground="White"/>
                            <Border Classes="hover-overlay"
                                    IsHitTestVisible="False"
                                    Background="Transparent"
                                    CornerRadius="12"/>
                        </Grid>
                    </ExperimentalAcrylicBorder>

                    <!-- Botão de ordenação -->
                    <ExperimentalAcrylicBorder Grid.Column="1"
                                               CornerRadius="12"
                                               Width="44"
                                               Height="44"
                                               Margin="10,0,0,0"
                                               VerticalAlignment="Center"
                                               ClipToBounds="True">
                        <ExperimentalAcrylicBorder.Material>
                            <ExperimentalAcrylicMaterial
                                TintColor="Black"
                                TintOpacity="0.35"/>
                        </ExperimentalAcrylicBorder.Material>

                        <Button
                            Classes="filter"
                            Background="Transparent"
                            BorderBrush="Transparent"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"
                            Padding="0"
                            ToolTip.Tip="Order by">
                                <Button.Content>
                                    <Path
                                        Width="20"
                                        Height="20"
                                        Stretch="Uniform"
                                        Fill="SlateGray"
                                        Data="M214.6 105.4C202.1 92.9 181.8 92.9 169.3 105.4L89.3 185.4C76.8 197.9 76.8 218.2 89.3 230.7C101.8 243.2 122.1 243.2 134.6 230.7L160 205.3L160 512C160 529.7 174.3 544 192 544C209.7 544 224 529.7 224 512L224 205.3L249.4 230.7C261.9 243.2 282.2 243.2 294.7 230.7C307.2 218.2 307.2 197.9 294.7 185.4L214.7 105.4zM352 128C352 145.7 366.3 160 384 160L434.7 160L361.3 233.4C352.1 242.6 349.4 256.3 354.4 268.3C359.4 280.3 371.1 288 384 288L512 288C529.7 288 544 273.7 544 256C544 238.3 529.7 224 512 224L461.3 224L534.7 150.6C543.9 141.4 546.6 127.7 541.6 115.7C536.6 103.7 525 96 512 96L384 96C366.3 96 352 110.3 352 128zM476.6 337.7C471.2 326.8 460.1 320 448 320C435.9 320 424.8 326.8 419.4 337.7L339.4 497.7C331.5 513.5 337.9 532.7 353.7 540.6C369.5 548.5 388.7 542.1 396.6 526.3L403.8 512L492.2 512L499.4 526.3C507.3 542.1 526.5 548.5 542.3 540.6C558.1 532.7 564.5 513.5 556.6 497.7L476.6 337.7zM448 423.6L468.2 464L427.8 464L448 423.6z"/>
                                </Button.Content>
                                <Button.Flyout>
                                    <MenuFlyout>
                                        <MenuItem Header="A-Z"
                                                  Command="{Binding SortCommand}"
                                                  CommandParameter="AZ"/>
                                        <MenuItem Header="Z-A"
                                                  Command="{Binding SortCommand}"
                                                  CommandParameter="ZA"/>
                                        <MenuItem Header="default"
                                                  Command="{Binding SortCommand}"
                                                  CommandParameter="NATIVE"/>
                                    </MenuFlyout>
                                </Button.Flyout>
                            </Button>
                    </ExperimentalAcrylicBorder>
                    <!-- Botão de refresh na coluna 2 -->
                    <ExperimentalAcrylicBorder Grid.Column="2"
                                               CornerRadius="12"
                                               Width="44"
                                               Height="44"
                                               Margin="10,0,0,0"
                                               VerticalAlignment="Center"
                                               ClipToBounds="True">
                        <ExperimentalAcrylicBorder.Material>
                            <ExperimentalAcrylicMaterial TintColor="Black" TintOpacity="0.35"/>
                        </ExperimentalAcrylicBorder.Material>

                        <Button Command="{Binding RefreshGamesCommand}"
                                Background="Transparent"
                                BorderBrush="Transparent"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"
                                ToolTip.Tip="Refresh">
                            <Button.Content>
                                <Path
                                    Width="20"
                                    Height="20"
                                    Stretch="Uniform"
                                    Fill="SlateGray"
                                    Data="M552 256L408 256C398.3 256 389.5 250.2 385.8 241.2C382.1 232.2 384.1 221.9 391 215L437.7 168.3C362.4 109.7 253.4 115 184.2 184.2C109.2 259.2 109.2 380.7 184.2 455.7C259.2 530.7 380.7 530.7 455.7 455.7C463.9 447.5 471.2 438.8 477.6 429.6C487.7 415.1 507.7 411.6 522.2 421.7C536.7 431.8 540.2 451.8 530.1 466.3C521.6 478.5 511.9 490.1 501 501C401 601 238.9 601 139 501C39.1 401 39 239 139 139C233.3 44.7 382.7 39.4 483.3 122.8L535 71C541.9 64.1 552.2 62.1 561.2 65.8C570.2 69.5 576 78.3 576 88L576 232C576 245.3 565.3 256 552 256z"/>
                            </Button.Content>
                        </Button>
                    </ExperimentalAcrylicBorder>
                </Grid>

                <!-- Recentes — só aparece se houver itens -->
                <StackPanel Grid.Row="1"
                            Margin="20,10,10,10"
                            Orientation="Vertical"
                            Spacing="4"
                            IsVisible="{Binding RecentGames, Converter={StaticResource RecentGamesToVisibilityConverter}}">
                    <TextBlock Text="Recents"
                               FontSize="14"
                               Margin="0,0,0,10"
                               FontWeight="SemiBold"
                               Foreground="DarkGray"/>

                    <ItemsControl ItemsSource="{Binding RecentGames}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="8"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Command="{Binding DataContext.GameClickedCommand, ElementName=RootWindow}"
                                        CommandParameter="{Binding}"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="0"
                                        Margin="0,0,8,0">
                                    <Border Width="80" Height="120" CornerRadius="6" ClipToBounds="True" Background="#22000000">
                                        <Image Source="{Binding FullCover}" Stretch="Uniform"/>
                                    </Border>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>


               <!-- Lista de jogos -->
                
                <ListBox Grid.Row="2"
                         ItemsSource="{Binding FilteredGames}"
                         Background="Transparent"
                         Foreground="White"
                         SelectionMode="Single"
                         SelectedItem="{Binding SelectedGame, Mode=TwoWay}"
                         IsVisible="{Binding ErrorMessage, Converter={StaticResource NullToBoolConverter}, ConverterParameter=Invert}">
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel/>
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>

                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="Auto,*" Margin="8,6">
                                <Border Width="96" Height="36" CornerRadius="6" ClipToBounds="True" Background="#22000000">
                                    <Image Source="{Binding Cover}"
                                           Stretch="Uniform"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           behaviors:LazyCoverLoader.IsEnabled="True"/>
                                </Border>
                                <StackPanel Grid.Column="1"
                                            Orientation="Horizontal"
                                            Spacing="8"
                                            VerticalAlignment="Center"
                                            Margin="10,0,0,0">
                                    <TextBlock Text="{Binding Name}"
                                               VerticalAlignment="Center"
                                               Foreground="White"
                                               FontSize="16"/>
                                    <TextBlock Text="{Binding AchievementsLabel}"
                                               VerticalAlignment="Center"
                                               Foreground="LightGray"
                                               FontSize="13"
                                               Margin="6,0,0,0"/>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>



            </Grid>
        </Grid>
    </Grid>
</Window>
